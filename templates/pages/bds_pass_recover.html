<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Excel User ID Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { background: #1e1e1e; color: #f0f0f0; font-family: sans-serif; padding: 20px; }
    .container { max-width: 1000px; margin: auto; background: #2a2a2a; padding: 25px; border-radius: 10px; position: relative; }
    input[type="file"], select, button {
      margin: 5px; padding: 10px; background: #333; color: #f0f0f0;
      border: 1px solid #555; border-radius: 5px;
    }
    button:hover { background-color: #555; }
    #excelOptions { margin: 10px 0; }
    .spinner {
      border: 5px solid #444; border-top: 5px solid #0f0;
      border-radius: 50%; width: 30px; height: 30px;
      animation: spin 1s linear infinite; margin-left: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }

    .table-container { max-height: 420px; overflow-y: auto; overflow-x: auto; border: 1px solid #444; border-radius: 6px; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px; border: 1px solid #444; white-space: nowrap; }
    th { background: #333; position: sticky; top: 0; z-index: 1; }
    tr:nth-child(even) { background-color: #2f2f2f; }
    tr:hover { background-color: #3a3a3a; }

    .counters-box {
      display: flex; flex-wrap: nowrap; justify-content: space-around;
      background: #222; border: 1px solid #555; border-radius: 6px;
      padding: 10px; margin: 15px 0; font-size: 16px; gap: 10px; overflow-x: auto;
    }
    .counters-box div {
      flex: 1 1 30%; text-align: center; min-width: 150px;
    }

    #circularProgress {
      position: absolute; top: 20px; right: 20px;
      width: 70px; height: 70px;
      background: conic-gradient(#28a745 0%, #444 0%);
      border-radius: 50%; display: none;
      justify-content: center; align-items: center;
      font-size: 16px; color: #fff; font-weight: bold;
      box-shadow: 0 0 10px #000; z-index: 10;
    }

    @media (max-width: 600px) {
      .counters-box { overflow-x: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="circularProgress">0%</div>

    <h1 style="text-align: center;">Live MBBS Password Checker</h1>
    <h4>üìÑ Upload Excel File</h4>
    <input type="file" id="inputFile" accept=".xlsx,.xls" />
    <div style="display: inline-flex; align-items: center;">
      <button onclick="handleUpload()">Upload</button>
      <div id="loader" class="spinner" style="display:none;"></div>
      <button id="downloadBtn" style="display:none; margin-left: 10px; background-color: #28a745;">
        ‚¨á Download Excel
      </button>
    </div>

    <div id="excelOptions" style="display:none; margin-top: 10px;">
      <label>User ID:</label><select id="userIdColumn"></select>
      <label>Mobile Number:</label><select id="mobileColumn"></select>
      <button id="submitBtn" onclick="startExcelProcessing()" style="display:none;">Submit & Process</button>
      <button id="cancelBtn" onclick="cancelProcessing()" style="display:none; background-color: #dc3545; margin-left: 10px;">‚õî Cancel</button>
    </div>

    <div id="counters" class="counters-box">
      <div>üî¢ Total: <span id="totalRows">0</span></div>
      <div>üîÑ Processed: <span id="processedRows">0</span></div>
      <div>‚úÖ Found Data: <span id="foundRows">0</span></div>
      <div>‚ùå Not Found: <span id="notFoundRows">0</span></div>
      <div>‚ö†Ô∏è Data Error: <span id="errorRows">0</span></div>
    </div>
    
    <h3>üìä Result Table:</h3>
    <div class="table-container">
      <table id="resultsTable">
        <thead>
          <tr><th>SL</th><th>User ID</th><th>Mobile</th><th>Result</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let uploadedExcelPath = "";
    let evtSource = null;

    function handleUpload() {
      const file = document.getElementById("inputFile").files[0];
      if (!file) return alert("Please select a file");

      const formData = new FormData();
      formData.append("input_file", file);

      fetch("/upload", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.type === "excel") {
            uploadedExcelPath = data.file_path;
            const userIdSel = document.getElementById("userIdColumn");
            const mobileSel = document.getElementById("mobileColumn");
            userIdSel.innerHTML = "";
            mobileSel.innerHTML = "";
            data.columns.forEach(col => {
              const opt1 = document.createElement("option");
              opt1.value = col;
              opt1.textContent = col;
              userIdSel.appendChild(opt1);

              const opt2 = document.createElement("option");
              opt2.value = col;
              opt2.textContent = col;
              mobileSel.appendChild(opt2);
            });
            document.getElementById("excelOptions").style.display = "block";
            document.getElementById("submitBtn").style.display = "inline-block";
            document.getElementById("cancelBtn").style.display = "inline-block";
          } else {
            alert(data.error || "Unsupported file type");
          }
        });
    }

    function startExcelProcessing() {
      const params = new URLSearchParams({
        file_path: uploadedExcelPath,
        user_col: document.getElementById("userIdColumn").value,
        mobile_col: document.getElementById("mobileColumn").value,
      });
      startProcessing("/process?" + params.toString());
    }

    function startProcessing(url) {
      if (evtSource) evtSource.close();

      evtSource = new EventSource(url);
      const tbody = document.querySelector("#resultsTable tbody");
      const loader = document.getElementById("loader");
      const downloadBtn = document.getElementById("downloadBtn");
      const cancelBtn = document.getElementById("cancelBtn");

      const circularProgress = document.getElementById("circularProgress");
      const totalRowsEl = document.getElementById("totalRows");
      const processedRowsEl = document.getElementById("processedRows");
      const notFoundRowsEl = document.getElementById("notFoundRows");
      const errorRowsEl = document.getElementById("errorRows");
      const foundRowsEl = document.getElementById("foundRows");

      tbody.innerHTML = "";
      loader.style.display = "block";
      circularProgress.style.display = "flex";
      downloadBtn.style.display = "none";
      cancelBtn.style.display = "inline-block";

      totalRowsEl.textContent = "0";
      processedRowsEl.textContent = "0";
      notFoundRowsEl.textContent = "0";
      errorRowsEl.textContent = "0";
      foundRowsEl.textContent = "0";

      let serial = 1;
      let total = 0;

      evtSource.onmessage = function (event) {
        const data = JSON.parse(event.data);

        if (data.total_rows) {
          total = data.total_rows;
          totalRowsEl.textContent = total;
        }

        if (data.download) {
          loader.style.display = "none";
          circularProgress.style.display = "none";
          downloadBtn.style.display = "inline-block";
          cancelBtn.style.display = "none";
          downloadBtn.onclick = () => window.location.href = data.download;
          evtSource.close();
          evtSource = null;
        } else if (data["User ID"]) {
          const row = `<tr><td>${serial++}</td><td>${data["User ID"]}</td><td>${data["Mobile Number"]}</td><td>${data.Result}</td></tr>`;
          tbody.innerHTML += row;

          processedRowsEl.textContent = data.Processed;
          notFoundRowsEl.textContent = data.NotFound;
          errorRowsEl.textContent = data.ErrorCount ?? 0;

          const found = data.Processed - data.NotFound - (data.ErrorCount ?? 0);
          foundRowsEl.textContent = found >= 0 ? found : 0;

          if (total > 0) {
            const percent = Math.round((data.Processed / total) * 100);
            circularProgress.textContent = percent + "%";
            circularProgress.style.background = `conic-gradient(#28a745 ${percent}%, #444 ${percent}%)`;
          }
        } else if (data.error) {
          alert("‚ùå " + data.error);
          loader.style.display = "none";
          circularProgress.style.display = "none";
          cancelBtn.style.display = "none";
          evtSource.close();
          evtSource = null;
        }
      };

      evtSource.onerror = function () {
        loader.style.display = "none";
        circularProgress.style.display = "none";
        cancelBtn.style.display = "none";
        if (evtSource) {
          evtSource.close();
          evtSource = null;
        }
      };
    }

    function cancelProcessing() {
      if (evtSource) {
        evtSource.close();
        evtSource = null;
        alert("‚õî Processing cancelled.");
        document.getElementById("loader").style.display = "none";
        document.getElementById("circularProgress").style.display = "none";
        document.getElementById("cancelBtn").style.display = "none";
      }
    }
  </script>
</body>
</html>
