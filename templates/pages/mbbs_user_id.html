<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live User ID Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { background: #1e1e1e; color: #f0f0f0; font-family: sans-serif; padding: 20px; }
    .container { max-width: 1000px; margin: auto; background: #2a2a2a; padding: 25px; border-radius: 10px; position: relative; }
    input[type="file"], select, button {
      margin: 5px; padding: 10px; background: #333; color: #f0f0f0;
      border: 1px solid #555; border-radius: 5px;
    }
    button:hover { background-color: #555; }
    .spinner {
      border: 5px solid #444; border-top: 5px solid #0f0;
      border-radius: 50%; width: 30px; height: 30px;
      animation: spin 1s linear infinite; margin-left: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }

    .table-container { max-height: 420px; overflow-y: auto; overflow-x: auto; border: 1px solid #444; border-radius: 6px; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px; border: 1px solid #444; white-space: nowrap; }
    th { background: #333; position: sticky; top: 0; z-index: 1; }
    tr:nth-child(even) { background-color: #2f2f2f; }
    tr:hover { background-color: #3a3a3a; }

    .counters-box {
      display: flex; flex-wrap: nowrap; justify-content: space-around;
      background: #222; border: 1px solid #555; border-radius: 6px;
      padding: 10px; margin: 15px 0; font-size: 16px; gap: 10px; overflow-x: auto;
    }
    .counters-box div {
      flex: 1 1 30%; text-align: center; min-width: 150px;
    }

    #circularProgress {
      position: absolute; top: 20px; right: 20px;
      width: 70px; height: 70px;
      background: conic-gradient(#28a745 0%, #444 0%);
      border-radius: 50%; display: none;
      justify-content: center; align-items: center;
      font-size: 16px; color: #fff; font-weight: bold;
      box-shadow: 0 0 10px #000; z-index: 10;
    }

    #searchInput, #statusFilter {
      padding: 8px 100px; margin: 10px 5px 0 0;
      background: #1f1f1f; color: #f0f0f0; border: 1px solid #444; border-radius: 5px;
    }

    @media (max-width: 600px) {
      .counters-box { overflow-x: auto; flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="circularProgress">0%</div>

    <h1 style="text-align: center;">Live MBBS User ID Checker</h1>
    <h4>üìÑ Upload DOCX or Excel File</h4>
    <input type="file" id="inputFile" accept=".docx,.xlsx,.xls" />
    <div style="display: inline-flex; align-items: center;">
      <button onclick="handleUpload()">Upload</button>
      <div id="loader" class="spinner" style="display:none;"></div>
      <button id="downloadBtn" style="display:none; margin-left: 10px; background-color: #28a745;">
        ‚¨á Download Excel
      </button>
    </div>

    <div id="excelOptions" style="display:none;">
      <label>Name:</label><select id="nameColumn"></select>
      <label>Father's Name:</label><select id="fatherColumn"></select>
      <label>Mobile Number:</label><select id="mobileColumn"></select>
      <button id="submitBtn" onclick="startExcelProcessing()">Submit & Process</button>
      <button id="cancelBtn" onclick="cancelProcessing()" style="display:none; background-color:#dc3545;">‚õî Cancel</button>
    </div>

    <div class="counters-box">
      <div>üî¢ Total: <span id="totalRows">0</span></div>
      <div>üîÑ Processed: <span id="processedRows">0</span></div>
      <div>‚úÖ Found Data: <span id="foundRows">0</span></div>
      <div>‚ùå Not Found: <span id="notFoundRows">0</span></div>
      <div>‚ö†Ô∏è Data Error: <span id="errorRows">0</span></div>
    </div>

    <div>
      üîç Search: <input type="text" id="searchInput" placeholder="Search..." />
      üìå Filter by Result:
      <select id="statusFilter">
        <option value="">-- All --</option>
        <option value="found">‚úÖ Found</option>
        <option value="sorry">‚ùå Not Found</option>
        <option value="failed">‚ö†Ô∏è Failed</option>
      </select>
    </div>

    <div class="table-container">
      <table id="resultsTable">
        <thead>
          <tr><th>SL</th><th>Name</th><th>Father's Name</th><th>Mobile</th><th>MBBS User ID</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let uploadedExcelPath = "";
    let evt = null;

    function handleUpload() {
      const file = document.getElementById("inputFile").files[0];
      if (!file) return alert("Select a file");

      const formData = new FormData();
      formData.append("input_file", file);

      fetch("/upload", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.type === "excel") {
            uploadedExcelPath = data.file_path;
            ["nameColumn", "fatherColumn", "mobileColumn"].forEach(id => {
              const sel = document.getElementById(id);
              sel.innerHTML = "";
              data.columns.forEach(col => {
                const opt = document.createElement("option");
                opt.value = col;
                opt.textContent = col;
                sel.appendChild(opt);
              });
            });
            document.getElementById("excelOptions").style.display = "block";
            document.getElementById("submitBtn").style.display = "inline-block";
          } else if (data.type === "docx") {
            startProcessing("/process?file_path=" + encodeURIComponent(data.file_path));
          }
        });
    }

    function startExcelProcessing() {
      const params = new URLSearchParams({
        file_path: uploadedExcelPath,
        name_col: document.getElementById("nameColumn").value,
        father_col: document.getElementById("fatherColumn").value,
        mobile_col: document.getElementById("mobileColumn").value,
      });
      startProcessing("/process?" + params.toString());
    }

    function startProcessing(url) {
      if (evt) evt.close();

      evt = new EventSource(url);
      const tbody = document.querySelector("#resultsTable tbody");
      const loader = document.getElementById("loader");
      const downloadBtn = document.getElementById("downloadBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const circularProgress = document.getElementById("circularProgress");

      const totalRowsEl = document.getElementById("totalRows");
      const processedRowsEl = document.getElementById("processedRows");
      const notFoundRowsEl = document.getElementById("notFoundRows");
      const errorRowsEl = document.getElementById("errorRows");
      const foundRowsEl = document.getElementById("foundRows");

      tbody.innerHTML = "";
      loader.style.display = "block";
      circularProgress.style.display = "flex";
      cancelBtn.style.display = "inline-block";
      downloadBtn.style.display = "none";

      totalRowsEl.textContent = "0";
      processedRowsEl.textContent = "0";
      notFoundRowsEl.textContent = "0";
      errorRowsEl.textContent = "0";
      foundRowsEl.textContent = "0";

      let serial = 1;
      let total = 0;

      evt.onmessage = function (event) {
        const data = JSON.parse(event.data);

        if (data.total_rows) {
          total = data.total_rows;
          totalRowsEl.textContent = total;
        }

        if (data.download) {
          loader.style.display = "none";
          circularProgress.style.display = "none";
          cancelBtn.style.display = "none";
          downloadBtn.style.display = "inline-block";
          downloadBtn.onclick = () => window.location.href = data.download;
          evt.close();
        } else if (data.Name) {
          const resultText = data["MBBS User ID"].toLowerCase();
          const status = resultText.includes("sorry") ? "sorry"
                       : resultText.includes("failed") ? "failed"
                       : "found";

          const row = `<tr data-status="${status}">
                        <td>${serial++}</td>
                        <td>${data.Name}</td>
                        <td>${data["Father's Name"]}</td>
                        <td>${data["Mobile Number"]}</td>
                        <td>${data["MBBS User ID"]}</td>
                      </tr>`;
          tbody.innerHTML += row;

          processedRowsEl.textContent = data.Processed;
          notFoundRowsEl.textContent = data.NotFound;
          errorRowsEl.textContent = data.ErrorCount ?? 0;

          const found = data.Processed - data.NotFound - (data.ErrorCount ?? 0);
          foundRowsEl.textContent = found >= 0 ? found : 0;

          if (total > 0) {
            const percent = Math.round((data.Processed / total) * 100);
            circularProgress.textContent = percent + "%";
            circularProgress.style.background = `conic-gradient(#28a745 ${percent}%, #444 ${percent}%)`;
          }
        } else if (data.error) {
          alert("‚ùå " + data.error);
          loader.style.display = "none";
          circularProgress.style.display = "none";
          cancelBtn.style.display = "none";
          evt.close();
        }
      };

      evt.onerror = function () {
        loader.style.display = "none";
        circularProgress.style.display = "none";
        cancelBtn.style.display = "none";
        evt.close();
      };
    }

    function cancelProcessing() {
      if (evt) {
        evt.close();
        evt = null;
        document.getElementById("loader").style.display = "none";
        document.getElementById("circularProgress").style.display = "none";
        document.getElementById("cancelBtn").style.display = "none";
        alert("‚õî Processing cancelled.");
      }
    }

    function applyFilters() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const filter = document.getElementById("statusFilter").value;

      const rows = document.querySelectorAll("#resultsTable tbody tr");
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        const status = row.getAttribute("data-status");
        const matchSearch = text.includes(search);
        const matchFilter = !filter || status === filter;

        row.style.display = matchSearch && matchFilter ? "" : "none";
      });
    }

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.getElementById("statusFilter").addEventListener("change", applyFilters);
  </script>
</body>
</html>
